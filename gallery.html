<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Media Gallery</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
        }

        .controls {
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }


        .controls label {
            margin-right: 10px;
        }

        .controls input[type="range"] {
            width: 200px;
            vertical-align: middle;
        }

        .grid {
            margin: 10px;
            min-height: 100vh;
            overflow: visible;
        }

        .grid-item {
            width: 250px;
            margin-bottom: 10px;
            box-sizing: border-box;
            overflow: hidden;
            cursor: pointer;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .grid-item img,
        .grid-item video {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Fullscreen Overlay */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .fullscreen-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .fullscreen-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .fullscreen-content img,
        .fullscreen-content video {
            max-width: calc(100vw - 20px);
            max-height: calc(100vh - 20px);
            object-fit: contain;
            border-radius: 4px;
        }

        /* Navigation Controls */
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            z-index: 1002;
        }

        .nav-btn:hover {
            background-color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: translateY(-50%) scale(0.9);
        }

        .prev-btn {
            left: 20px;
        }

        .next-btn {
            right: 20px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1002;
            background-color: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Media Info */
        .media-info {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1002;
            pointer-events: none;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #d32f2f;
            font-size: 16px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .fullscreen-content {
                padding: 60px 20px 20px 20px;
            }

            .nav-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .prev-btn {
                left: 10px;
            }

            .next-btn {
                right: 10px;
            }

            .close-btn {
                top: 10px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="thumbnailWidth">Thumbnail Width:</label>
        <input type="range" id="thumbnailWidth" min="100" max="400" value="250">
    </div>

    <div class="grid"></div>

    <div id="fullscreenOverlay" class="fullscreen-overlay">
        <span class="close-btn">&times;</span>
        <button class="nav-btn prev-btn" id="prevBtn">‹</button>
        <button class="nav-btn next-btn" id="nextBtn">›</button>
        <div class="fullscreen-content"></div>
        <div class="media-info" id="mediaInfo"></div>
    </div>

    <script src="js/masonry.pkgd.min.js"></script>
    <script src="js/imagesloaded.pkgd.min.js"></script>


    <!-- Main Gallery Script -->
    <script>
        // Embedded media files data
        const MEDIA_FILES = [];
        const MEDIA_DATA = {};

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded. Initializing gallery.');
            const grid = document.querySelector('.grid');
            const thumbnailWidthSlider = document.getElementById('thumbnailWidth');
            const fullscreenOverlay = document.getElementById('fullscreenOverlay');
            const fullscreenContent = document.querySelector('.fullscreen-content');
            const closeFullscreenBtn = document.querySelector('.fullscreen-overlay .close-btn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const mediaInfo = document.getElementById('mediaInfo');

            let masonry;
            let allMediaFiles = [...MEDIA_FILES]; // Create a shallow copy to shuffle
            shuffleArray(allMediaFiles); // Shuffle the array
            const filesPerLoad = 20;
            let loadedMediaCount = 0;
            let isLoading = false;
            let videoObservers = new Map();
            let currentMediaIndex = -1;

            const supportedExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.mp4', '.webm', '.ogg'];

            console.log(`Found ${allMediaFiles.length} media files.`);
            if (allMediaFiles.length === 0) {
                grid.innerHTML = '<div class="error">No media files found in the gallery.</div>';
                return;
            }

            // Create Media Element
            function createMediaElement(fileName) {
                const lowerFileName = fileName.toLowerCase();
                let mediaElement;

                if (supportedExtensions.some(ext => ['.mp4', '.webm', '.ogg'].includes(ext) && lowerFileName.endsWith(ext))) {
                    mediaElement = document.createElement('video');
                    mediaElement.autoplay = false;
                    mediaElement.muted = true;
                    mediaElement.loop = true;
                    mediaElement.preload = 'metadata';
                    mediaElement.playsInline = true;
                } else {
                    mediaElement = document.createElement('img');
                    mediaElement.loading = 'lazy';
                }

                // Use embedded data URL
                mediaElement.src = MEDIA_DATA[fileName];
                return mediaElement;
            }

            // Initialize or reinitialize Masonry
            function initializeMasonry() {
                if (masonry) {
                    masonry.destroy();
                }
                masonry = new Masonry(grid, {
                    itemSelector: '.grid-item',
                    columnWidth: parseInt(thumbnailWidthSlider.value),
                    gutter: 10,
                    fitWidth: true
                });
            }

            // Append Media to Grid - FIXED VERSION
            function appendMediaToGrid(files) {
                if (files.length === 0) return;

                const elements = files.map((fileName) => {
                    const gridItem = document.createElement('div');
                    gridItem.classList.add('grid-item');
                    gridItem.dataset.fileName = fileName;

                    gridItem.style.width = `${thumbnailWidthSlider.value}px`;

                    const mediaElement = createMediaElement(fileName);
                    gridItem.appendChild(mediaElement);

                    gridItem.addEventListener('click', () => {
                        openFullscreen(fileName);
                    });

                    if (mediaElement.tagName.toLowerCase() === 'video') {
                        setupVideoObserver(mediaElement);
                    }

                    return gridItem;
                });

                grid.append(...elements);

                // FIXED: Handle first initialization vs subsequent loads differently
                if (masonry) {
                    // For subsequent loads, append and wait for images
                    masonry.appended(elements);
                    // Use imagesLoaded with a small delay to ensure proper layout
                    setTimeout(() => {
                        imagesLoaded(elements, function() {
                            masonry.layout();
                        });
                    }, 10);
                } else {
                    // For first load, wait for images BEFORE initializing Masonry
                    imagesLoaded(elements, function() {
                        initializeMasonry();
                        // Additional layout call after a short delay to ensure everything is settled
                        setTimeout(() => {
                            if (masonry) masonry.layout();
                        }, 50);
                    });
                }
            }

            // Load More Media
            function loadMoreMedia() {
                if (isLoading) return;

                const nextBatch = allMediaFiles.slice(loadedMediaCount, loadedMediaCount + filesPerLoad);
                if (nextBatch.length > 0) {
                    isLoading = true;
                    appendMediaToGrid(nextBatch);
                    loadedMediaCount += nextBatch.length;
                    isLoading = false;

                    if (grid.offsetHeight < window.innerHeight && loadedMediaCount < allMediaFiles.length) {
                        loadMoreMedia();
                    }
                }
            }

            // Video Observer
            function setupVideoObserver(videoElement) {
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                videoElement.play().catch(e => console.warn('Video play failed:', e));
                            } else {
                                videoElement.pause();
                            }
                        });
                    }, { threshold: 0.7 });
                    observer.observe(videoElement);
                    videoObservers.set(videoElement, observer);
                } else {
                    videoElement.autoplay = true;
                }
            }

            // Smart scaling function for images
            function applySmartScaling(mediaElement) {
                if (mediaElement.tagName.toLowerCase() !== 'img') return;

                function doScaling() {
                    const imgWidth = mediaElement.naturalWidth;
                    const imgHeight = mediaElement.naturalHeight;
                    const viewportWidth = window.innerWidth - 20;
                    const viewportHeight = window.innerHeight - 20;

                    const scaleX = viewportWidth / imgWidth;
                    const scaleY = viewportHeight / imgHeight;
                    const scale = Math.min(scaleX, scaleY);

                    if (scale > 1 || (imgWidth < viewportWidth * 0.8 && imgHeight < viewportHeight * 0.8)) {
                        const targetScale = Math.min(scaleX, scaleY, 3);
                        mediaElement.style.width = Math.floor(imgWidth * targetScale) + 'px';
                        mediaElement.style.height = Math.floor(imgHeight * targetScale) + 'px';
                    } else {
                        mediaElement.style.width = 'auto';
                        mediaElement.style.height = 'auto';
                    }
                }

                if (mediaElement.complete && mediaElement.naturalWidth > 0) {
                    doScaling();
                } else {
                    mediaElement.onload = doScaling;
                }
            }

            function openFullscreen(fileName) {
                const mediaIndex = allMediaFiles.indexOf(fileName);
                if (mediaIndex === -1) return;

                currentMediaIndex = mediaIndex;
                const lowerFileName = fileName.toLowerCase();
                const isVideo = supportedExtensions.some(ext => ['.mp4', '.webm', '.ogg'].includes(ext) && lowerFileName.endsWith(ext));

                fullscreenContent.innerHTML = '';

                let mediaElement;
                if (isVideo) {
                    mediaElement = document.createElement('video');
                    mediaElement.controls = true;
                    mediaElement.autoplay = true;
                    mediaElement.loop = true;
                    mediaElement.muted = false;
                } else {
                    mediaElement = document.createElement('img');
                }

                mediaElement.src = MEDIA_DATA[fileName];
                fullscreenContent.appendChild(mediaElement);

                applySmartScaling(mediaElement);

                updateNavigationState();
                fullscreenOverlay.classList.add('visible');

                document.querySelectorAll('.grid-item video').forEach(video => {
                    video.pause();
                });
            }

            function updateNavigationState() {
                prevBtn.disabled = currentMediaIndex <= 0;
                nextBtn.disabled = currentMediaIndex >= allMediaFiles.length - 1;

                const fileName = allMediaFiles[currentMediaIndex];
                mediaInfo.textContent = `${currentMediaIndex + 1} / ${allMediaFiles.length} - ${fileName}`;
            }

            function closeFullscreen() {
                fullscreenOverlay.classList.remove('visible');
                fullscreenContent.innerHTML = '';
                currentMediaIndex = -1;

                document.querySelectorAll('.grid-item video').forEach(video => {
                    if (videoObservers.has(video)) {
                        // Let observer handle it
                    } else {
                        video.play().catch(e => console.warn('Video play failed:', e));
                    }
                });
            }

            function navigateFullscreen(direction) {
                const newIndex = currentMediaIndex + direction;
                if (newIndex >= 0 && newIndex < allMediaFiles.length) {
                    currentMediaIndex = newIndex;
                    const fileName = allMediaFiles[newIndex];
                    const lowerFileName = fileName.toLowerCase();
                    const isVideo = supportedExtensions.some(ext => ['.mp4', '.webm', '.ogg'].includes(ext) && lowerFileName.endsWith(ext));

                    fullscreenContent.innerHTML = '';

                    let mediaElement;
                    if (isVideo) {
                        mediaElement = document.createElement('video');
                        mediaElement.controls = true;
                        mediaElement.autoplay = true;
                        mediaElement.loop = true;
                        mediaElement.muted = false;
                    } else {
                        mediaElement = document.createElement('img');
                    }

                    mediaElement.src = MEDIA_DATA[fileName];
                    fullscreenContent.appendChild(mediaElement);

                    applySmartScaling(mediaElement);

                    updateNavigationState();
                }
            }

            // Event Listeners
            thumbnailWidthSlider.addEventListener('input', () => {
                const newWidth = parseInt(thumbnailWidthSlider.value);
                document.querySelectorAll('.grid-item').forEach(item => {
                    item.style.width = `${newWidth}px`;
                });
                if (masonry) {
                    masonry.options.columnWidth = newWidth;
                    masonry.layout();
                }
            });

            closeFullscreenBtn.addEventListener('click', closeFullscreen);
            prevBtn.addEventListener('click', () => navigateFullscreen(-1));
            nextBtn.addEventListener('click', () => navigateFullscreen(1));

            fullscreenOverlay.addEventListener('click', (event) => {
                if (event.target === fullscreenOverlay) {
                    closeFullscreen();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (fullscreenOverlay.classList.contains('visible')) {
                    switch(event.key) {
                        case 'Escape':
                            closeFullscreen();
                            break;
                        case 'ArrowLeft':
                            navigateFullscreen(-1);
                            break;
                        case 'ArrowRight':
                            navigateFullscreen(1);
                            break;
                    }
                }
            });

            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 500) &&
                    !isLoading && loadedMediaCount < allMediaFiles.length) {
                    loadMoreMedia();
                }
            });

            // Initialize
            loadMoreMedia();
        });
    </script>
</body>
</html>
