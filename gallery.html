<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Watcher ‚Äî Gallery Generator</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:0}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#222;color:#fff}
    .controls{display:flex;gap:12px;align-items:center}
    main{padding:16px}
    .pick{display:flex;gap:12px;align-items:center}
    .note{color:#555;margin-top:8px}
    .generated{margin-top:16px}
    button{cursor:pointer}
    input[type="file"]{display:none}
    a.download-link{display:inline-block;margin-right:12px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:600">Media Watcher ‚Äî Gallery Generator</div>
    <div class="controls">
      <button id="openPicker">Choose folder</button>
      <button id="generateBtn" disabled>Generate gallery HTML</button>
    </div>
  </header>
  <main>
    <div class="pick">
      <label id="chosenLabel">No folder chosen</label>
      <input id="dirPicker" type="file" webkitdirectory directory multiple />
    </div>
    <div class="note">
      Pick a local folder and generate a standalone gallery HTML file (one per selection). The generated gallery includes:
      delete icons, an auto-delete option that removes viewed files, Undo for last deletion (5s), Mark all, a Trash view with unmarking and downloadable delete scripts.
    </div>

    <div class="generated" id="generatedArea"></div>
  </main>

  <script>
    // Renderer template (will be injected into the generated gallery HTML)
    const RENDERER_JS = `
(function(){
  const FILE_LIST = __FILE_LIST__;
  const MEDIA_ROOT = "__MEDIA_ROOT__";

  // Build page
  document.title = 'Gallery - ' + MEDIA_ROOT;

  // simple DOM structure
  document.body.innerHTML = `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Media Watcher Gallery</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:0}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#222;color:#fff}
  .path{font-size:0.9rem;opacity:0.9}
  .controls{display:flex;gap:12px;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;padding:12px}
  .card{border:1px solid #ddd;padding:6px;background:#fff;display:flex;flex-direction:column;gap:6px}
  .thumb{height:120px;object-fit:cover;width:100%;background:#111;color:#ddd;display:flex;align-items:center;justify-content:center}
  .meta{display:flex;justify-content:space-between;align-items:center;font-size:0.85rem}
  .trash{cursor:pointer;position:relative}
  .badge{position:absolute;top:-6px;right:-6px;background:crimson;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
  .modal .box{background:#fff;padding:16px;max-width:900px;width:95%;max-height:80%;overflow:auto}
  button{cursor:pointer}
  .undo{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:8px 12px;border-radius:6px;display:none}
  .controls button{background:#fff;border:0;padding:6px 10px;border-radius:4px}
  .controls label{color:#fff}
</style>
</head>
<body>
  <header>
    <div>
      <div style="font-weight:600">Media Watcher</div>
      <div class="path" id="mediaPath">Media: /</div>
    </div>
    <div class="controls">
      <label><input type="checkbox" id="autoDelete"> Auto-delete (delete on view)</label>
      <button id="markAll">Mark all</button>
      <div class="trash" id="trashBtn" title="Marked for deletion">
        üóëÔ∏è<span class="badge" id="trashCount" style="display:none">0</span>
      </div>
    </div>
  </header>

  <div class="grid" id="grid"></div>

  <div class="modal" id="trashModal">
    <div class="box">
      <h3>Files marked for deletion (<span id="markedCount">0</span>)</h3>
      <div id="markedList"></div>
      <hr />
      <div>
        <button id="downloadBash">Download bash delete script</button>
        <button id="downloadWin">Download Windows delete script (.bat)</button>
        <button id="copyScript">Copy bash script to clipboard</button>
        <button id="closeTrash">Close</button>
      </div>
    </div>
  </div>

  <button class="undo" id="undoBtn">Undo last delete</button>

<script>
  // FILE_LIST and MEDIA_ROOT will be injected by generator
  const FILE_LIST = __FILE_LIST__;
  const MEDIA_ROOT = '__MEDIA_ROOT__';
</script>

<script>
(function(){
  const grid = document.getElementById('grid');
  const mediaPathEl = document.getElementById('mediaPath');
  const autoDeleteEl = document.getElementById('autoDelete');
  const trashBtn = document.getElementById('trashBtn');
  const trashCountEl = document.getElementById('trashCount');
  const trashModal = document.getElementById('trashModal');
  const markedListEl = document.getElementById('markedList');
  const markedCountEl = document.getElementById('markedCount');
  const undoBtn = document.getElementById('undoBtn');
  const markAllBtn = document.getElementById('markAll');
  const downloadBash = document.getElementById('downloadBash');
  const downloadWin = document.getElementById('downloadWin');
  const copyScript = document.getElementById('copyScript');
  const closeTrash = document.getElementById('closeTrash');

  mediaPathEl.textContent = 'Media: ' + MEDIA_ROOT;

  const state = {
    marked: new Set(),
    lastDeleted: null,
    undoTimer: null,
    removedDOM: new Map()
  };

  function updateTrashCount(){
    const n = state.marked.size;
    if(n>0){
      trashCountEl.style.display='inline-block';
      trashCountEl.textContent = n;
    } else {
      trashCountEl.style.display='none';
    }
  }

  function renderGrid(){
    grid.innerHTML = '';
    FILE_LIST.forEach(function(rel){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.rel = rel;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      // Assume relative path: put gallery file in parent of MEDIA_ROOT (or serve)
      const fullPath = (MEDIA_ROOT.replace(/\/+$/,'') + '/' + rel).replace(/\+/g,'/');

      if(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(rel)){
        const img = document.createElement('img');
        img.src = fullPath;
        img.className = 'thumb';
        img.alt = rel;
        img.loading = 'lazy';
        thumb.appendChild(img);
      } else {
        thumb.textContent = rel.split('/').slice(-1)[0];
      }

      const meta = document.createElement('div');
      meta.className = 'meta';

      const label = document.createElement('div');
      label.textContent = rel;
      label.style.overflow='hidden';
      label.style.textOverflow='ellipsis';
      label.style.whiteSpace='nowrap';
      label.style.maxWidth='60%';

      const controls = document.createElement('div');

      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'View';
      viewBtn.onclick = function(){
        window.open(fullPath, '_blank');
        if(autoDeleteEl.checked){
          performDelete(rel, card);
        }
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = 'Mark for deletion';
      delBtn.onclick = function(){
        markForDeletion(rel);
        // also reflect checkbox visual state
        renderGrid();
      };

      const chk = document.createElement('input');
      chk.type='checkbox';
      chk.checked = state.marked.has(rel);
      chk.onchange = function(){
        if(chk.checked) state.marked.add(rel); else state.marked.delete(rel);
        updateTrashCount();
      };

      controls.appendChild(viewBtn);
      controls.appendChild(delBtn);
      controls.appendChild(chk);

      meta.appendChild(label);
      meta.appendChild(controls);

      card.appendChild(thumb);
      card.appendChild(meta);

      grid.appendChild(card);
    });
    updateTrashCount();
  }

  function markForDeletion(rel){
    state.marked.add(rel);
    state.lastDeleted = rel;
    updateTrashCount();
    showUndo();
  }

  function performDelete(rel, cardEl){
    // mark + remove from DOM, save DOM for undo
    state.marked.add(rel);
    state.lastDeleted = rel;
    state.removedDOM.set(rel, cardEl.cloneNode(true));
    cardEl.remove();
    updateTrashCount();
    showUndo();
  }

  function showUndo(){
    undoBtn.style.display='block';
    if(state.undoTimer) clearTimeout(state.undoTimer);
    state.undoTimer = setTimeout(function(){
      // expire undo
      state.lastDeleted = null;
      undoBtn.style.display='none';
      state.undoTimer = null;
    }, 5000);
  }

  undoBtn.onclick = function(){
    if(state.lastDeleted){
      const rel = state.lastDeleted;
      if(state.removedDOM.has(rel)){
        const node = state.removedDOM.get(rel);
        grid.appendChild(node);
        state.removedDOM.delete(rel);
      }
      if(state.marked.has(rel)) state.marked.delete(rel);
      state.lastDeleted = null;
      if(state.undoTimer) clearTimeout(state.undoTimer);
      undoBtn.style.display='none';
      updateTrashCount();
    }
  };

  trashBtn.onclick = function(){
    populateMarkedList();
    trashModal.style.display='flex';
  };

  closeTrash.onclick = function(){trashModal.style.display='none'};

  function populateMarkedList(){
    markedListEl.innerHTML='';
    const arr = Array.from(state.marked);
    markedCountEl.textContent = arr.length;
    if(arr.length===0){
      markedListEl.textContent='No files marked for deletion.';
      return;
    }
    arr.forEach(function(rel){
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent='space-between';
      row.style.padding='6px 0';
      const name = document.createElement('div');
      name.textContent = rel;
      const unmark = document.createElement('button');
      unmark.textContent='Unmark';
      unmark.onclick = function(){ state.marked.delete(rel); updateTrashCount(); populateMarkedList(); };
      row.appendChild(name);
      row.appendChild(unmark);
      markedListEl.appendChild(row);
    });
  }

  markAllBtn.onclick = function(){
    FILE_LIST.forEach(f=>state.marked.add(f));
    updateTrashCount();
    renderGrid();
  };

  function buildBashScript(){
    const lines = ['#!/bin/sh','# Delete script generated by media_watcher',''];
    Array.from(state.marked).forEach(rel=>{
      const p = (MEDIA_ROOT.replace(/\/+$/,'') + '/' + rel).replace(/\/g,'/');
      lines.push('rm -v -- "' + p.replace(/"/g,'\"') + '"');
    });
    return lines.join('\n') + '\n';
  }

  function buildWinScript(){
    const lines = ['@echo off','rem Delete script generated by media_watcher',''];
    Array.from(state.marked).forEach(rel=>{
      const p = (MEDIA_ROOT.replace(/\/+$/,'') + '\' + rel).replace(/\/g,'\\');
      lines.push('del /f /q "' + p + '"');
    });
    return lines.join('\r\n') + '\r\n';
  }

  function download(filename, content){
    const blob = new Blob([content],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),1000);
  }

  downloadBash.onclick = function(){ download('delete_marked.sh', buildBashScript()); };
  downloadWin.onclick = function(){ download('delete_marked.bat', buildWinScript()); };
  copyScript.onclick = function(){ navigator.clipboard.writeText(buildBashScript()); alert('Bash delete script copied to clipboard'); };

  // initial render
  renderGrid();
})();
</script>
</body>
</html>`;

    const dirPicker = document.getElementById('dirPicker');
    const openPicker = document.getElementById('openPicker');
    const chosenLabel = document.getElementById('chosenLabel');
    const generateBtn = document.getElementById('generateBtn');
    const generatedArea = document.getElementById('generatedArea');

    let lastSelection = null;

    openPicker.addEventListener('click', ()=> dirPicker.click());

    dirPicker.addEventListener('change', (ev)=>{
      const files = Array.from(dirPicker.files || []);
      if(files.length===0){
        chosenLabel.textContent = 'No folder chosen';
        generateBtn.disabled = true;
        return;
      }
      // webkitRelativePath contains the relative path from the chosen directory
      const first = files[0];
      const rel = first.webkitRelativePath || first.name;
      // derive root by taking the first path segment of webkitRelativePath
      const root = (first.webkitRelativePath && first.webkitRelativePath.split('/')[0]) || rel;
      chosenLabel.textContent = root + ' (' + files.length + ' files)';
      lastSelection = {root, files};
      generateBtn.disabled = false;
      generatedArea.innerHTML = '';
    });

    generateBtn.addEventListener('click', ()=>{
      if(!lastSelection) return;
      const {root, files} = lastSelection;
      // build file list of relative paths (relative to root)
      const fileList = files.map(f => (f.webkitRelativePath || f.name).replace(new RegExp('^' + root + '/?'), '')).map(p=>p.replace(/\/g,'/'));

      // create the gallery HTML by replacing placeholders in RENDERER_JS
      const fileListJson = JSON.stringify(fileList);
      const mediaRootEscaped = root.replace(/"/g,'\"');
      const finalHtml = '<!doctype html>\n<html lang="en">\n<head>\n<meta charset="utf-8"/>\n<meta name="viewport" content="width=device-width,initial-scale=1"/>\n<title>Gallery - ' + root + '</title>\n</head>\n<body>\n' +
        RENDERER_JS.replace('__FILE_LIST__', fileListJson).replace(/__MEDIA_ROOT__/g, mediaRootEscaped) + '\n</body>\n</html>';

      const now = new Date().toISOString().replace(/[:.]/g,'-');
      const filename = `gallery_${root}_${now}.html`;
      const blob = new Blob([finalHtml], {type:'text/html'});
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.textContent = `Download generated gallery: ${filename}`;
      link.className = 'download-link';

      generatedArea.innerHTML = '';
      generatedArea.appendChild(link);

      const openBtn = document.createElement('button');
      openBtn.textContent = 'Open in new tab';
      openBtn.onclick = ()=> window.open(url, '_blank');
      generatedArea.appendChild(openBtn);

      // revoke after some time (user should download)
      setTimeout(()=>URL.revokeObjectURL(url), 60*1000);

      generateBtn.disabled = true;
    });
  };
  </script>
</body>
</html>`;
